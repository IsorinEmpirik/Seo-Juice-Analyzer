{% extends "layout.html" %}

{% block title %}Résultats - Analyse de Maillage Interne{% endblock %}

{% block extra_head %}
<!-- Chart.js pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
<!-- DataTables pour les tableaux -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
    .stat-card {
        transition: transform 0.3s ease;
    }
    .stat-card:hover {
        transform: translateY(-5px);
    }
    .score-badge {
        font-size: 2rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">

    <!-- Header -->
    <div class="row mt-4 mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="display-5 fw-bold text-primary">
                        <i class="bi bi-graph-up-arrow"></i>
                        Résultats de l'Analyse
                    </h1>
                    <p class="text-muted">Analyse du maillage interne et distribution du jus SEO</p>
                </div>
                <div>
                    <a href="/" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> Nouvelle analyse
                    </a>
                    <button class="btn btn-success" id="export-sheets-btn">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Exporter vers Google Sheets
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card stat-card shadow-sm border-0 bg-primary text-white">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 opacity-75">URLs Analysées</h6>
                    <div class="score-badge">{{ results.total_urls }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card shadow-sm border-0 bg-success text-white">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 opacity-75">Liens Internes</h6>
                    <div class="score-badge">{{ results.total_internal_links }}</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card shadow-sm border-0 bg-info text-white">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 opacity-75">Backlinks Externes</h6>
                    <div class="score-badge">{{ results.total_backlinks }}</div>
                </div>
            </div>
        </div>        <div class="col-md-3">
            <div class="card stat-card shadow-sm border-0 {% if results.error_juice_rate > 10 %}bg-danger{% else %}bg-warning{% endif %} text-white">
                <div class="card-body">
                    <h6 class="card-subtitle mb-2 opacity-75">Jus SEO sur Erreurs</h6>
                    <div class="score-badge">{{ "%.2f"|format(results.error_juice_rate) }}%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top 10 Pages -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-trophy"></i>
                        Top 10 Pages - Meilleur Score SEO
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>URL</th>
                                    <th>Score SEO</th>
                                    <th>Backlinks</th>
                                    <th>Liens Internes Reçus</th>
                                    <th>Catégorie</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for url_data in results.urls[:10] %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <a href="{{ url_data.url }}" target="_blank" class="text-decoration-none">
                                            {{ url_data.url[:60] }}...
                                        </a>
                                    </td>
                                    <td>
                                        <span class="badge bg-success fs-6">
                                            {{ "%.2f"|format(url_data.seo_score) }}/100
                                        </span>
                                    </td>
                                    <td>{{ url_data.backlinks_count }}</td>
                                    <td>{{ url_data.internal_links_received }}</td>
                                    <td><span class="badge bg-secondary">{{ url_data.category }}</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques -->
    <div class="row mb-4">
        <!-- Score par catégorie -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-pie-chart"></i>
                        Score Moyen par Catégorie
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Top sources de jus -->
        <div class="col-md-6 mb-3">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-bar-chart"></i>
                        Top 10 Sources de Jus SEO
                    </h6>
                </div>
                <div class="card-body">
                    <canvas id="sourcesChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Pages en erreur -->
    {% if results.error_pages_with_links %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0 border-start border-danger border-5">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        Pages en Erreur Recevant des Liens ({{ results.error_pages_with_links|length }})
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Ces pages reçoivent des liens internes mais retournent des codes d'erreur (redirections, 404, etc.)</p>
                    <div class="table-responsive">
                        <table class="table table-sm" id="error-table">
                            <thead>
                                <tr>
                                    <th>URL</th>
                                    <th>Code Statut</th>
                                    <th>Liens Reçus</th>
                                    <th>Score SEO</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for url_data in results.error_pages_with_links[:20] %}
                                <tr>
                                    <td>{{ url_data.url[:70] }}...</td>
                                    <td>
                                        <span class="badge
                                            {% if url_data.status_code >= 400 %}bg-danger
                                            {% elif url_data.status_code >= 300 %}bg-warning
                                            {% endif %}">
                                            {{ url_data.status_code }}
                                        </span>
                                    </td>
                                    <td>{{ url_data.internal_links_received }}</td>
                                    <td>{{ "%.2f"|format(url_data.seo_score) }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>

<!-- Stocker les données pour les graphiques -->
<script>
    const analysisId = "{{ analysis_id }}";
    const resultsData = {{ results|tojson }};
</script>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/results.js') }}"></script>
{% endblock %}
